<link rel="import" href="../polymer/polymer-element.html">

<dom-module id="month-scroller">
  <template>
    <style>
      :host {
        display: block;
        overflow-x: scroll;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 100px;
        margin-bottom: -60px;
        background-color: hsl(230, 10%, 90%);
        position: relative;
      }

      .months {
        display: flex;
        width: calc(12 * 100vw);
        transition: transform 0.3s;
      }

      .month {
        display: flex;
        width: 100vw;
        flex-wrap: wrap;
        padding: 0 14px;
        box-sizing: border-box;
      }

      .month .header {
        width: 100vw;
        text-align: center;
        font-size: 20px;
        font-weight: 600px;
        padding: 24px 0;
      }

      .day {
        width: calc((100vw - 28px) / 7);
        height: 40px;
        line-height: 40px;
        text-align: center;
      }

      .selected-day {
        background: #007AFF;
        border-radius: 4px;
        color: #FFF;
        font-weight: 600;
      }
    </style>

    <div class="months"></div>
  </template>

  <script>
    class MonthScroller extends Polymer.Element {
      static get is() {
        return 'month-scroller';
      }

      static get properties() {
        return {
          year: {
            type: Number,
            notify: true
          },
          month: {
            type: Number,
            notify: true
          },
          selectedDate: {
            type: String,
            notify: true
          },
          fastScrolling: {
            type: Boolean,
            value: false,
            notify: true
          }
        }
      }

      static get observers() {
        return [ /* observer descriptors */ ]
      }

      constructor() {
        super();
      }

      scrollToMonth(month) {
        this.scrollLeft = this.offsetWidth * ((month || Â this.month) - 1);
      }

      connectedCallback() {
        super.connectedCallback();

        const months = this.root.querySelector(".months");

        // Generate 12 dummy months
        for (var i = 1; i <= 12; i++) {
          var html = `<div class="month" data-month="${i}">`;
          html += `<div class="header">${this.getMonthName(i)}</div>`;
          for (var j = 1; j <= 31; j++) {
            html += `<div class="day">${j}</div>`;
          }
          html += `</div>`;
          months.innerHTML += html;
        }

        months.addEventListener("click", function(e) {
          if (e.target.classList.contains("day")) {
            var month = parseInt(e.target.parentNode.getAttribute("data-month"));
            var day = parseInt(e.target.textContent);
            this.selectedDate = month + "/" + day + "/" + this.year;

            if(this.root.querySelector(".selected-day"))
              this.root.querySelector(".selected-day").classList.remove("selected-day");
            e.target.classList.add("selected-day");
          }
        }.bind(this));

        // Fake smooth scrollTo animation
        var avoidGlass = false;
        const finishScrollTo = function() {
          months.removeEventListener("transitionend", finishScrollTo);
          avoidGlass = true;
          this.scrollLeft += this._scrollOffset;
          this.fastScrolling = false;
          months.style.transition = "none";
          months.style.transform = "translateX(0)";
          setTimeout(function() {
            months.style.transition = "";
            this.style.overflowX = "";
            this.style.webkitOverflowScrolling = "";
          }.bind(this), 10);
        }.bind(this);

        const scrollTo = function(offset) {
          this._scrollOffset = offset;
          months.addEventListener("transitionend", finishScrollTo);
          months.style.transform = `translateX(${-offset}px)`;
          this.month = Math.round(this.scrollLeft / this.offsetWidth) + 1;
        }.bind(this);

        // Emulate scroll snap points (very crudely)
        const snap = function() {
          var offset = this.scrollLeft % this.offsetWidth;
          if (offset < this.offsetWidth / 2) {
            scrollTo(-offset);
          } else {
            scrollTo(this.offsetWidth - offset);
          }
          this.fastScrolling = false;
        }.bind(this);

        var snapTimeout;
        var lastScrollDelta = [];
        var lastScrollLeft = -1;
        var stopping = false;

        this.addEventListener("scroll", function(e) {
          lastScrollDelta.push(Math.abs(lastScrollLeft - this.scrollLeft));
          lastScrollLeft = this.scrollLeft;
          this.month = Math.round(this.scrollLeft / this.offsetWidth) + 1;

          if (lastScrollDelta[lastScrollDelta.length - 1] > 55 && !avoidGlass) {
            // Scrolling fast, show glass
            this.fastScrolling = true;
          } else if (this.fastScrolling && lastScrollDelta[lastScrollDelta.length - 1] < 3) {
            this.fastScrolling = false;
          }

          avoidGlass = false;

          // if(stopping && lastScrollLeft >= 0) {
          //   this.scrollLeft = lastScrollLeft;
          //   return;
          // }
          // if (!stopping && lastScrollDelta.length > 8 && lastScrollDelta[lastScrollDelta.length - 1] < 10) {
          //   stopping = true;
          //   this.style.overflow = "hidden";
          //   this.style.webkitOverflowScrolling = "auto";
          //   setTimeout(function() {
          //     stopping = false;
          //     this.style.overflow = "";
          //     this.style.webkitOverflowScrolling = "";
          //   }.bind(this), 10);
          // } else {
          //   lastScrollLeft = this.scrollLeft;
          // }

          clearTimeout(snapTimeout);
          snapTimeout = setTimeout(snap, 100);
        }.bind(this));

        // Scroll to current month
        setTimeout(this.scrollToMonth.bind(this), 0);
      }

      getMonthName(month) {
        return ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][month - 1];
      }
    }

    customElements.define(MonthScroller.is, MonthScroller);

  </script>
</dom-module>
